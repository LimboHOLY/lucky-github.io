<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>neobman.casino</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root {
            --bg: #0b0e14;
            --accent: #8b5cf6;
            --pink: #ec4899;
            --text: #f8fafc;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        .game-area { flex: 1; position: relative; background: radial-gradient(circle at center, #1e1b4b 0%, #0b0e14 100%); overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }

        .multiplier-display {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; z-index: 5;
        }
        #currentX { font-size: 5rem; font-weight: 900; text-shadow: 0 0 30px rgba(139, 92, 246, 0.5); color: #fff; }
        .status-label { text-transform: uppercase; letter-spacing: 3px; color: #94a3b8; font-weight: 700; }

        .history {
            position: absolute; top: 10px; left: 0; width: 100%;
            display: flex; gap: 8px; padding: 10px; overflow-x: auto; justify-content: flex-start;
        }
        .badge { background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 8px; font-weight: 700; font-size: 0.8rem; color: #8b5cf6; white-space: nowrap; }

        .controls { background: #161b22; padding: 20px; border-top: 2px solid rgba(255,255,255,0.05); }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

        .input-box { background: #0b0e14; border: 1px solid #30363d; border-radius: 12px; padding: 8px; display: flex; align-items: center; flex: 1; margin: 0 5px; position: relative;}
        .input-box span { font-size: 0.7rem; color: #8b949e; position: absolute; top: -8px; left: 10px; background: #161b22; padding: 0 4px; }
        input { background: transparent; border: none; color: white; width: 100%; text-align: center; font-size: 1.1rem; font-weight: 700; outline: none; }

        .btn-main {
            width: 100%; padding: 20px; border-radius: 16px; border: none; font-size: 1.3rem; font-weight: 900;
            color: white; cursor: pointer; transition: 0.2s; text-transform: uppercase;
        }
        .btn-bet { background: linear-gradient(135deg, #8b5cf6, #ec4899); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }
        .btn-cashout { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-disabled { background: #30363d; color: #8b949e; pointer-events: none; }

        .switch { width: 40px; height: 20px; background: #30363d; border-radius: 20px; position: relative; cursor: pointer; margin-right: 10px; transition: 0.3s; }
        .switch.active { background: #22c55e; }
        .switch::after { content: ''; width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.2s; }
        .switch.active::after { left: 22px; }

        #toast {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); padding: 10px 20px; border-radius: 20px;
            font-weight: 700; opacity: 0; transition: 0.3s; z-index: 100; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="toast"></div>
<div class="history" id="historyBar"></div>

<div class="game-area" id="container">
    <canvas id="canvas"></canvas>
    <div class="multiplier-display">
        <div id="currentX">1.00x</div>
        <div class="status-label" id="statusLabel">–û–ñ–ò–î–ê–ù–ò–ï...</div>
    </div>
</div>

<div class="controls">
    <div class="row">
        <div>
            <div style="color: #8b949e; font-size: 0.8rem;">–ë–ê–õ–ê–ù–°</div>
            <div style="font-size: 1.4rem; font-weight: 900;"><span id="balanceDisplay">1000</span> TON</div>
        </div>
        <div style="text-align: right;">
            <div style="color: #8b949e; font-size: 0.8rem;">–ò–ì–†–û–ö</div>
            <div style="color: #22c55e; font-weight: 700;" id="userName">Guest</div>
        </div>–∏—Ä
    </div>

    <div class="row">
        <div class="input-box">
            <span>–°–¢–ê–í–ö–ê</span>
            <input type="number" id="betInput" value="100" min="10">
        </div>
        <div class="input-box" style="flex: 0.8;">
            <span>–ê–í–¢–û-–í–´–í–û–î</span>
            <div class="switch" id="autoToggle" onclick="toggleAuto()"></div>
            <input type="number" id="autoInput" value="2.00" step="0.1" min="1.1">
        </div>
    </div>

    <button id="mainBtn" class="btn-main btn-bet" onclick="handleButtonClick()">–ü–û–°–¢–ê–í–ò–¢–¨</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –°—Å—ã–ª–∫–∞ –±–µ—Ä–µ—Ç—Å—è –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –¥–æ–º–µ–Ω–∞ (ngrok)
    const API_URL = "https://biodiversity-sixth-wheels-civil.trycloudflare.com";
        const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 12345;
    document.getElementById('userName').innerText = tg.initDataUnsafe?.user?.first_name || "Guest";

    let balance = 0;
    let isFlying = false;
    let currentX = 1.0;
    let myActiveBet = null;
    let autoEnabled = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Canvas
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    function resize() {
        canvas.width = document.getElementById('container').offsetWidth;
        canvas.height = document.getElementById('container').offsetHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function toggleAuto() {
        autoEnabled = !autoEnabled;
        document.getElementById('autoToggle').classList.toggle('active', autoEnabled);
    }

    function showToast(text, color = "#fff") {
        const t = document.getElementById('toast');
        t.innerText = text;
        t.style.color = color;
        t.style.opacity = "1";
        setTimeout(() => t.style.opacity = "0", 2000);
    }

    async function handleButtonClick() {
        if (!isFlying && !myActiveBet) {
            // –°—Ç–∞–≤–∏–º —Å—Ç–∞–≤–∫—É
            const amount = parseFloat(document.getElementById('betInput').value);
            if (amount > balance) return showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞", "#ef4444");

            try {
                const res = await fetch(`${API_URL}/update_balance`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: String(userId), amount: -amount })
                });
                const data = await res.json();
                if (data.success) {
                    balance = data.balance;
                    myActiveBet = amount;
                    updateUI();
                    showToast("–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!", "#22c55e");
                }
            } catch (e) { console.error(e); }
        } else if (isFlying && myActiveBet) {
            // –ó–∞–±–∏—Ä–∞–µ–º –≤—ã–∏–≥—Ä—ã—à
            cashout();
        }
    }

    async function cashout() {
        if (!myActiveBet) return;
        const winAmount = myActiveBet * currentX;
        myActiveBet = null;

        try {
            const res = await fetch(`${API_URL}/update_balance`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: String(userId), amount: winAmount })
            });
            const data = await res.json();
            balance = data.balance;
            updateUI();
            showToast(`–í–´–ò–ì–†–´–®: ${winAmount.toFixed(2)} TON`, "#f59e0b");
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        } catch (e) { console.error(e); }
    }

    function updateUI() {
        document.getElementById('balanceDisplay').innerText = Math.floor(balance);
        const btn = document.getElementById('mainBtn');

        if (myActiveBet) {
            if (isFlying) {
                btn.className = "btn-main btn-cashout";
                btn.innerText = `–ó–ê–ë–†–ê–¢–¨ ${(myActiveBet * currentX).toFixed(1)}`;
            } else {
                btn.className = "btn-main btn-disabled";
                btn.innerText = "–°–¢–ê–í–ö–ê –ü–†–ò–ù–Ø–¢–ê";
            }
        } else {
            btn.className = "btn-main btn-bet";
            btn.innerText = isFlying ? "–ñ–î–ï–ú –†–ê–£–ù–î–ê" : "–ü–û–°–¢–ê–í–ò–¢–¨";
        }
    }

    async function sync() {
        try {
            const res = await fetch(`${API_URL}/game_status`);
            const data = await res.json();

            const wasFlying = isFlying;
            isFlying = data.is_flying;
            currentX = data.multiplier;

            if (isFlying) {
                document.getElementById('currentX').innerText = currentX.toFixed(2) + 'x';
                document.getElementById('statusLabel').innerText = "–ü–û–õ–ï–¢...";
                // –ê–≤—Ç–æ–≤—ã–≤–æ–¥
                if (myActiveBet && autoEnabled) {
                    const target = parseFloat(document.getElementById('autoInput').value);
                    if (currentX >= target) cashout();
                }
            } else {
                document.getElementById('currentX').innerText = data.time_left.toFixed(1) + 's';
                document.getElementById('statusLabel').innerText = "–í–ó–õ–ï–¢ –ß–ï–†–ï–ó";
                if (wasFlying) {
                    myActiveBet = null; // –°–±—Ä–æ—Å —Å—Ç–∞–≤–∫–∏ –µ—Å–ª–∏ –Ω–µ —É—Å–ø–µ–ª –∑–∞–±—Ä–∞—Ç—å
                }
                updateHistory(data.history);
            }
            updateUI();
        } catch (e) {}
    }

    function updateHistory(history) {
        const bar = document.getElementById('historyBar');
        bar.innerHTML = '';
        history.slice(-10).reverse().forEach(val => {
            const b = document.createElement('div');
            b.className = 'badge';
            b.innerText = val.toFixed(2) + 'x';
            bar.appendChild(b);
        });
    }

    // –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (isFlying) {
            ctx.beginPath();
            ctx.strokeStyle = "#8b5cf6";
            ctx.lineWidth = 4;
            let x = (currentX / 10) * canvas.width; if(x > canvas.width * 0.8) x = canvas.width * 0.8;
            let y = canvas.height - (Math.log(currentX) * 80) - 60;
            ctx.moveTo(0, canvas.height - 60);
            ctx.quadraticCurveTo(x/2, canvas.height - 40, x, y);
            ctx.stroke();
            ctx.font = "40px Arial";
            ctx.fillText("üöÄ", x - 20, y + 10);
        }
        requestAnimationFrame(draw);
    }

    async function init() {
        const r = await fetch(`${API_URL}/get_balance/${userId}`);
        const d = await r.json();
        balance = d.balance;
        updateUI();
        setInterval(sync, 100);
        draw();
    }
    init();
</script>
</body>
</html>
