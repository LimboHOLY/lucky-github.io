<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crash TON Live</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg-color: #0f1111; --card-bg: #1a1d20; --accent: #0088cc; --win: #4caf50; --lose: #ff4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: white; margin: 0; padding: 15px; overflow: hidden; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .balance-chip { background: #1c2a35; padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; border: 1px solid #2a3f4e; }
        .balance-chip img { width: 18px; margin-right: 8px; }
        .balance-val { font-weight: bold; color: #fff; font-size: 16px; }

        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ —Å —Å–µ—Ç–∫–æ–π */
        #game-area { 
            height: 250px; background: #0b141a; border-radius: 15px; position: relative;
            overflow: hidden; border: 1px solid #222; margin-bottom: 20px;
            background-image: linear-gradient(#16212a 1px, transparent 1px), linear-gradient(90deg, #16212a 1px, transparent 1px);
            background-size: 40px 40px;
        }
        #multiplier { 
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            font-size: 50px; font-weight: 900; z-index: 10; text-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        #rocket { 
            position: absolute; bottom: 20px; left: 20px; width: 60px; height: 60px; 
            font-size: 40px; display: flex; align-items: center; justify-content: center;
            transition: all 0.1s linear; transform: rotate(45deg);
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .input-group { text-align: left; margin-bottom: 15px; }
        .input-group label { color: #888; font-size: 12px; margin-left: 5px; }
        input { 
            width: 100%; background: #0f1111; border: 1px solid #333; padding: 12px; 
            border-radius: 10px; color: white; font-size: 18px; margin-top: 5px; box-sizing: border-box; outline: none;
        }

        .btn-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { 
            padding: 15px; border-radius: 12px; border: none; font-size: 16px; 
            font-weight: bold; cursor: pointer; color: white; transition: 0.2s;
        }
        .btn-bet { background: #0088cc; }
        .btn-cash { background: #4caf50; opacity: 0.3; pointer-events: none; }
        .btn-active { opacity: 1 !important; pointer-events: auto !important; transform: scale(1.02); }
        .btn:disabled { background: #333 !important; opacity: 0.5; cursor: not-allowed; }
        
        .status-text { font-size: 12px; color: #555; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="status-text">LIVE <span id="online-count" style="color: #4caf50;">‚óè 124</span></div>
        <div class="balance-chip">
            <img src="https://cryptologos.cc/logos/toncoin-ton-logo.png" alt="ton">
            <span id="balance" class="balance-val">0.00</span>
        </div>
    </div>

    <div id="game-area">
        <div id="multiplier">1.00x</div>
        <div id="rocket">üöÄ</div>
    </div>

    <div class="controls">
        <div class="input-group">
            <label>–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞</label>
            <input type="number" id="betInput" value="100">
        </div>
        <div class="btn-box">
            <button id="betBtn" class="btn btn-bet" onclick="placeBet()">–ü–û–°–¢–ê–í–ò–¢–¨</button>
            <button id="cashBtn" class="btn btn-cash" onclick="cashOut()">–ó–ê–ë–†–ê–¢–¨</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –°–°–´–õ–ö–ê –ò–ó CLOUDFLARE (–£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–Ω–∞ –≤–µ—Ä–Ω–∞—è!)
        const API_URL = "https://mechanics-multiple-addressing-animal.trycloudflare.com";
        const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 12345;

        let myBalance = 0;
        let isBetting = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ: –º—ã –≤ –∏–≥—Ä–µ –∏–ª–∏ –Ω–µ—Ç
        let hasWon = false;    // –°–æ—Å—Ç–æ—è–Ω–∏–µ: —É—Å–ø–µ–ª–∏ –ª–∏ –∑–∞–±—Ä–∞—Ç—å –¥–µ–Ω—å–≥–∏
        let serverMult = 1.0;

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        async function api(path, method = "GET", body = null) {
            try {
                const options = { method, headers: { 'Accept': 'application/json' }};
                if (body) {
                    options.method = "POST";
                    options.body = JSON.stringify(body);
                    options.headers['Content-Type'] = 'application/json';
                }
                const res = await fetch(`${API_URL}${path}`, options);
                return await res.json();
            } catch (e) { return null; }
        }

        async function updateBalanceUI() {
            const data = await api(`/get_balance/${userId}`);
            if (data) {
                myBalance = data.balance;
                document.getElementById('balance').innerText = myBalance.toFixed(2);
            }
        }

        // –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
        async function mainLoop() {
            const data = await api("/game_status");
            if (!data) return;

            const multEl = document.getElementById('multiplier');
            const rocket = document.getElementById('rocket');
            const betBtn = document.getElementById('betBtn');
            const cashBtn = document.getElementById('cashBtn');

            serverMult = data.multiplier;

            if (data.is_flying) {
                // –†–ê–ö–ï–¢–ê –õ–ï–¢–ò–¢
                multEl.innerText = serverMult.toFixed(2) + "x";
                multEl.style.color = "white";
                
                // –î–≤–∏–≥–∞–µ–º —Ä–∞–∫–µ—Ç—É (–≥—Ä–∞—Ñ–∏–∫–∞)
                let move = (serverMult - 1) * 45;
                rocket.style.left = (20 + move) + "px";
                rocket.style.bottom = (20 + move * 0.8) + "px";

                // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫
                if (!isBetting) {
                    betBtn.disabled = true; // –ù–µ–ª—å–∑—è –∑–∞–π—Ç–∏, –∫–æ–≥–¥–∞ —É–∂–µ –ª–µ—Ç–∏—Ç
                } else if (isBetting && !hasWon) {
                    cashBtn.classList.add('btn-active'); // –ú–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å
                }
            } else {
                // –ö–†–ê–® (–ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏)
                multEl.innerText = "CRASH!";
                multEl.style.color = "#ff4444";
                rocket.style.left = "20px";
                rocket.style.bottom = "20px";
                
                // –°–±—Ä–æ—Å –Ω–∞—à–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                isBetting = false;
                hasWon = false;
                
                betBtn.disabled = false;
                cashBtn.classList.remove('btn-active');
                updateBalanceUI();
            }
        }

        // –°—Ç–∞–≤–∫–∞
        async function placeBet() {
            const amount = parseFloat(document.getElementById('betInput').value);
            if (amount > myBalance || amount <= 0) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");

            const res = await api("/update_balance", "POST", { user_id: userId, amount: -amount });
            if (res) {
                isBetting = true;
                hasWon = false;
                document.getElementById('betBtn').disabled = true;
                updateBalanceUI();
            }
        }

        // –ó–∞–±—Ä–∞—Ç—å –¥–µ–Ω—å–≥–∏
        async function cashOut() {
            if (!isBetting || hasWon) return;
            
            const amount = parseFloat(document.getElementById('betInput').value);
            const win = amount * serverMult;
            
            const res = await api("/update_balance", "POST", { user_id: userId, amount: win });
            if (res) {
                hasWon = true;
                isBetting = false;
                document.getElementById('cashBtn').classList.remove('btn-active');
                alert(`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${win.toFixed(2)} TON!`);
                updateBalanceUI();
            }
        }

        // –ó–∞–ø—É—Å–∫
        updateBalanceUI();
        setInterval(mainLoop, 100); // –û–ø—Ä–æ—Å —Å–µ—Ä–≤–µ—Ä–∞ 10 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
    </script>
</body>
</html>

